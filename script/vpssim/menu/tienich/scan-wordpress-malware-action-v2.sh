#!/bin/bash
if [ ! -f /tmp/server_wp_all_scan ] && [ -f /home/vpssim.conf ]; then
. /home/vpssim.conf
fi
echoY() {
echo -e "\033[38;5;148m${1}\033[39m"
}
echoG() {
echo -e "\033[38;5;71m${1}\033[39m"
}
echoR()
{
echo -e "\033[38;5;203m${1}\033[39m"
}

#
checkWgrCode=0
chmodUser=""
home_path="/home/"
displayLog=0
for_rebuild="no"

# cau hinh linh dong theo tung loai host
if [ -f /tmp/server_wp_all_scan ]; then

. /tmp/server_wp_all_scan

else

# con lai se cho nguoi dung nhap path
echo -n "Enter folder for check and scan (default /home): "
read root_dir
if [ "$root_dir" == "" ]; then
	root_dir="/home"
else
	# xac dinh user dung de chmod
	if [ ! "$root_dir" == "/home" ] && [[ ! "$root_dir" == *"$home_path"* ]]; then
		echo -n "chmod to user (default: auto detect): "
		read chmodUser
	fi
fi
if [ ! -d $root_dir ]; then
	echoR $root_dir" not exist..."
	exit
fi

#
echo -n "Maximum folder for foreach (maximum 10, default 3): "
read MaxCheck
if [ "$MaxCheck" == "" ]; then
	MaxCheck=3
fi

#
echo -n "Show log after done (default: y | Please choose: y/n): "
read showDoneLog
if [ "$showDoneLog" == "" ] || [ "$showDoneLog" == "y" ]; then
	displayLog=1
fi

fi

#
cd ~
echo $(date) > /root/scan-wordpress-malware-log.txt

#
echoG "OK OK, scan wordpres upload website in: "$root_dir
echo "Max for: "$MaxCheck
echo "Show log: "$displayLog
echo "User: "$chmodUser
echoY "Will begin after 2s..."
#echo "TEST: "$root_dir
#exit
sleep 2

#
cd ~
cat > "/tmp/find_php_file" <<END
#!/bin/sh 
END

#
cat > "/tmp/find_htaccess_file" <<END
#!/bin/sh 
END

#
find_php_htaccess_file_in_dir(){
echo "Dir scan: "$1
if [ -d "$1" ]; then
cat >> "/tmp/find_php_file" <<END
find $1 -type f -name '*.php'
END

cat >> "/tmp/find_htaccess_file" <<END
find $1 -type f -name '*.htaccess'
END
fi
}

#
find_and_check_file_mimetype(){
echo "Dir scan: "$1

#
sub_scan="yes"
if [ "$2" == "no" ]; then
	sub_scan="no"
fi
echo "Sub scan: "$sub_scan

#
if [ -d "$1" ]; then
	for scan_d in $1/*
	do
		if [ -d "$scan_d" ]; then
			echo $scan_d
			basename_d=$(basename $scan_d)
			# khong scan thu muc ebcache, va chi scan thu muc con khi co yeu cau
			if [ ! "$basename_d" == "ebcache" ] && [ ! "$sub_scan" == "no" ]; then
				find_and_check_file_mimetype $scan_d
			else
				echo "Disable scan sub-folder"
			fi
		elif [ -f "$scan_d" ]; then
			#filename $(basename $scan_d)
			filename=$(basename -- "$scan_d")
			extension="${filename##*.}"
			#
			mime_type=$(file -b --mime-type $scan_d)
			#echo $mime_type

			# mang chua cac gia tri can so sanh
			arr_mime_type_image=("image/jpeg","image/png","image/x-ms-bmp","image/svg+xml","image/gif")

			# kiểm tra định dạng file xem có khớp với mime type không
			has_log=""
			if [ "$mime_type" == "video/mp4" ]; then
				if [ ! "$extension" == "mp4" ]; then
					has_log="warning"
				fi
			elif [[ "${arr_mime_type_image[*]}" =~ "${mime_type}" ]]; then
				arr_ext_image=("jpg","jpeg","png","bmp","svg","gif")
				if [[ ! "${arr_ext_image[*]}" =~ "${extension}" ]]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "text/plain" ]; then
				arr_ext_text_plain=("css","json","js","txt","log","html")
				if [[ ! "${arr_ext_text_plain[*]}" =~ "${extension}" ]]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "text/html" ]; then
				arr_ext_text_html=("shtml","html","htm")
				if [[ ! "${arr_ext_text_html[*]}" =~ "${extension}" ]]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "text/x-php" ]; then
				if [ ! "$extension" == "php" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "image/vnd.adobe.photoshop" ]; then
				if [ ! "$extension" == "psd" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/pdf" ]; then
				if [ ! "$extension" == "pdf" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/x-gzip" ]; then
				if [ ! "$extension" == "gz" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/msword" ]; then
				if [ ! "$extension" == "docx" ] && [ ! "$extension" == "doc" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/xml" ] || [ "$mime_type" == "application/xml-sitemap" ]; then
				if [ ! "$extension" == "xml" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/zip" ]; then
				if [ ! "$extension" == "zip" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/vnd.ms-excel" ]; then
				if [ ! "$extension" == "xlsx" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/x-font-ttf" ]; then
				if [ ! "$extension" == "ttf" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "inode/x-empty" ]; then
				# cac tep trong -> khong co noi dung gi thi co ve vo hai
				echo $mime_type
			else
				has_log="unknown"
			fi
			# nếu không khớp -> ghi log
			if [ ! "$has_log" == "" ]; then
				echoY $scan_d"::"$extension"::"$mime_type
				#echo $extension" :: "$scan_d"::"$mime_type >> /root/scan-wordpress-malware-log.txt
				echo $scan_d >> /root/scan-wordpress-malware-log.txt
				echo $mime_type"::"$extension >> /root/scan-wordpress-malware-log.txt
			fi
		else
			echo $scan_d
		fi
	done
else
	echo "Dir not exist::"$scan_d
fi
}

# kiem tra neu co file la thi dua ra canh bao
check_wp_suspect_malware_file(){
echoY "Check malware..."
checkFile=$1/index.php
if [ -f $checkFile ]; then
	# thu tim chuoi base64 decode trong file index php -> mac dinh thi file index php khong co doan nay
	if grep -q base64_decode "$checkFile"; then
		# gui canh bao ve telegram
		send_warning_via_telegram $1 "index"
	fi
fi
# file wp-login php la noi no thu thap thong tin dang nhap cua nguoi dung
checkFile=$1/wp-login.php
if [ -f $checkFile ]; then
	# thu tim chuoi logo.gif trong file wp-login php -> mac dinh thi file wp-login php khong co doan nay
	if grep -q logo.gif "$checkFile"; then
		# gui canh bao ve telegram
		send_warning_via_telegram $1 "wp-login"
	fi
fi
# file logo.gif nay cung do virus tao ra
if [ -f $1/logo.gif ]; then
	# gui canh bao ve telegram
	send_warning_via_telegram $1 "logogif"
fi

# kiem tra cac file khong dung chuan cua wordpress
wp_prefix="wp-"
for get_wp_f in $1/*
do
	if [ -f $get_wp_f ]; then
		filename=$(basename -- "$get_wp_f")
		extension="${filename##*.}"
		# neu la file php -> kiem tra xem co chu wp- o dau file khong
		if [ "$extension" == "php" ] && [ ! "$filename" == "index.php" ] && [ ! "$filename" == "xmlrpc.php" ]; then
			if [[ ! "$filename" == *"$wp_prefix"* ]]; then
				# gui canh bao ve telegram
				send_warning_via_telegram $1 $filename
			fi
		fi
	fi
done

# kiem tra da dung file htaccess cua WGR chua -> chi danh cho code cua WGR
if [ "$checkWgrCode" -ne 0 ]; then
	checkFile=$1/.htaccess
	# khong co file htaccess -> bao loi
	if [ ! -f $checkFile ]; then
		send_warning_via_telegram $1 "no_htaccess"
		update_default_htaccess $1
	else
		# thu tim chuoi www.old-domain.com trong file htaccess -> neu khong co thi khong phai file chuan cua WGR
		if grep -q www.old-domain.com "$checkFile"; then
			echoG "htaccess OK..."
		else
			# gui canh bao ve telegram
			# gui nhieu thong bao qua loan het ca tin nhan -> khong gui nua
			#send_warning_via_telegram $1 "wgr_htaccess"

			# update lai htaccess neu dang o thu muc public html
			is_public_html=$(basename $1)
			if [ "$is_public_html" == "public_html" ]; then
				update_default_htaccess $1
			fi
		fi
	fi
fi
}

send_warning_via_telegram(){
	#wget --no-check-certificate -O /dev/null "https://cloud.echbay.com/backups/has_malware?source="$2"&path="$1
	curl --data "source="$2"&path="$1 https://cloud.echbay.com/backups/has_malware
	echoY $2
}

# cap nhat lai file htaccess theo tieu chuan neu co yeu cau
update_default_htaccess(){
	yes | cp -rf /etc/vpssim/menu/tienich/.htaccess $1/.htaccess
	echoG "UPDATE htaccess..."
	for_rebuild="yes"
}

# tim tat ca thu muc trong home
get_all_dir_in_dir(){
echo "--------------------------------------------------------"
echo "Dir scan: "$1
echo "Re-scan: "$2
echo "Max scan: "$3
echo "Host user: "$4
# do sau toi da se kiem tra
if [ $2 -lt $3 ]; then
	for get_d in $1
	do
		# neu la thu muc thi kiem tra tiep
		if [ -d $get_d ]; then
			# neu la shortcut thi bo qua
			if [ -L $get_d ]; then
				echoY $get_d"::It is a symlink..."
			else
				#echo $get_d
				# tim it nhat 3 file va 3 thu muc bat buoc phai co cua wp
				if [ -f $get_d/wp-config.php ] && [ -d $get_d/wp-admin ] && [ -d $get_d/wp-content ] && [ -d $get_d/wp-includes ]; then
					#echo $get_d
					# tim duoc website wp
					echoG $get_d"::It is a wordpress website"
					
					# thu kiem tra xem site nay co dinh malware khong
					check_wp_suspect_malware_file $get_d
					
					# scan thu muc public_html
					find_and_check_file_mimetype $get_d "no"
					# scan thu muc upload
					find_and_check_file_mimetype $get_d"/wp-content/uploads"
					find_php_htaccess_file_in_dir $get_d"/wp-content/uploads"
					find_php_htaccess_file_in_dir $get_d"/wp-content/languages"
					find_and_check_file_mimetype $get_d"/uploads"
					find_php_htaccess_file_in_dir $get_d"/uploads"
					find_and_check_file_mimetype $get_d"/upload"
					find_php_htaccess_file_in_dir $get_d"/upload"
					find_and_check_file_mimetype $get_d"/public/uploads"
					find_php_htaccess_file_in_dir $get_d"/public/uploads"
					find_and_check_file_mimetype $get_d"/public/upload"
					find_php_htaccess_file_in_dir $get_d"/public/upload"
					find_php_htaccess_file_in_dir $get_d"/.well-known"
					find_php_htaccess_file_in_dir $get_d"/cgi-bin"
					echoG "Scan wordpress upload DONE..."
					sleep 3;
				else
					#echo $get_d
					stt=$2
					let "stt+=1"
					#echo $stt
					get_all_dir_in_dir $get_d"/*" $stt $3 $4
				fi
			fi
		fi
	done
fi
}
# lap tim cac website trong thu muc home
WP_scan_main(){
echo "Check WP upload in: "$root_dir
#exit
# voi cac thu muc khac, quet thang trong thu muc
if [ ! "$root_dir" == "/home" ]; then
	find_and_check_file_mimetype $root_dir
	echoG "Scan custom upload DONE..."
else
# voi thu muc home thi moi can do theo host
for main_dir in $root_dir/*
do
	# neu la thu muc -> tim cac file wp trong nay
	if [ -d $main_dir ]; then
		echo "d home: "$main_dir
		
		# tai khoan de chmod file sau khi update
		if [ "$chmodUser" == "" ]; then
			host_user=$(basename $main_dir)
		else
			host_user=$chmodUser
		fi
		echo "host user: "$host_user
		
		get_all_dir_in_dir $main_dir"/*" 0 $MaxCheck $host_user
		
		echo "========================================"
	fi
done
fi
}
WP_scan_main

#
cd ~
if [ ! "$for_rebuild" == "no" ]; then
	if [ -f /usr/local/lsws/bin/lswsctrl ]; then
		/usr/local/lsws/bin/lswsctrl restart
	else
		/bin/systemctl reload nginx.service
	fi
fi

#
cd ~
echo $(date) >> /root/scan-wordpress-malware-log.txt

#
echoG "nano /root/scan-wordpress-malware-log.txt"

#
if [ "$displayLog" -ne 0 ]; then
echoY "scan base64 decode in home"
grep -rlw --include='*.php' --exclude-dir='wp-includes' --exclude-dir='wp-admin' -e 'base64_decode' /home

echoY "scan @include in home"
grep -rlw --include='*.php' --exclude-dir='wp-includes' --exclude-dir='wp-admin' -e '@include' /home

echoY "scan htaccess 0444 modify in all folder"
grep -rlw --include='*.php' --exclude-dir='wp-includes' --exclude-dir='wp-admin' -e 'htaccess 0444 modify success' /

echoY "find php file"
chmod +x /tmp/find_php_file
/tmp/find_php_file

echoY "find htaccess file"
chmod +x /tmp/find_htaccess_file
/tmp/find_htaccess_file

# DONE -> show log
nano /root/scan-wordpress-malware-log.txt
fi

#
if [ ! -f /tmp/server_wp_all_scan ] && [ -f /home/vpssim.conf ]; then
/etc/vpssim/menu/vpssim-tien-ich
fi

#
cd ~ ;
rm -rf /tmp/server_wp_all_scan
cd ~ ;
